<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Cole Guerin, Thomas McMahon, Jerzy Wieczorek" />


<title>Checking dAIC calculations in survey::AIC.svyglm()</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Checking dAIC calculations in <code>survey::AIC.svyglm()</code></h1>
<h4 class="author">Cole Guerin, Thomas McMahon, Jerzy Wieczorek</h4>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(survey)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">library</span>(splines)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">library</span>(magrittr)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">library</span>(surveyCV)</span></code></pre></div>
<div id="generate-the-artificial-population" class="section level2">
<h2>Generate the artificial population</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a>x1 =<span class="st"> </span>stats<span class="op">::</span><span class="kw">runif</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">500</span>, <span class="dt">min =</span> <span class="dv">26</span>, <span class="dt">max =</span> <span class="dv">38</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a>y1 =<span class="st"> </span>(x1<span class="dv">-29</span>)<span class="op">^</span><span class="dv">3</span> <span class="op">-</span><span class="st"> </span><span class="dv">13</span><span class="op">*</span>(x1<span class="dv">-29</span>)<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">0</span><span class="op">*</span>(x1<span class="dv">-29</span>) <span class="op">+</span><span class="st"> </span><span class="dv">900</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="kw">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb3-6"><a href="#cb3-6"></a>x2 =<span class="st"> </span>stats<span class="op">::</span><span class="kw">runif</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">500</span>, <span class="dt">min =</span> <span class="dv">38</span>, <span class="dt">max =</span> <span class="dv">50</span>)</span>
<span id="cb3-7"><a href="#cb3-7"></a>y2 =<span class="st"> </span>(x2<span class="dv">-36</span>)<span class="op">^</span><span class="dv">3</span> <span class="op">-</span><span class="st"> </span><span class="dv">10</span><span class="op">*</span>(x2<span class="dv">-36</span>)<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>(x2<span class="dv">-36</span>) <span class="op">+</span><span class="st"> </span><span class="dv">600</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="kw">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: remove these 1st few duplicate lines eventually --</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co"># but would mess up the random seed, so don&#39;t remove yet</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co"># until we&#39;ve tested and can replicate old plots first...</span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co"># THEN when we are happy with ability to replicate old result,</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co"># revise so that both sets of sims (eval folds AND eval weights)</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co"># are using the SAME simulated dataset.</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>z1 =<span class="st"> </span><span class="kw">jitter</span>(y1, <span class="dv">15000</span>)</span>
<span id="cb3-17"><a href="#cb3-17"></a>z1 =<span class="st"> </span><span class="kw">jitter</span>(y1, <span class="dv">15000</span>)</span>
<span id="cb3-18"><a href="#cb3-18"></a>z2 =<span class="st"> </span><span class="kw">jitter</span>(y2, <span class="dv">15000</span>)</span>
<span id="cb3-19"><a href="#cb3-19"></a>z3 =<span class="st"> </span><span class="kw">jitter</span>(y1, <span class="dv">15000</span>)</span>
<span id="cb3-20"><a href="#cb3-20"></a>z4 =<span class="st"> </span><span class="kw">jitter</span>(y2, <span class="dv">15000</span>)</span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a>ds1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Response =</span> z1, <span class="dt">Predictor =</span> x1)</span>
<span id="cb3-23"><a href="#cb3-23"></a>ds2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Response =</span> z2, <span class="dt">Predictor =</span> x2)</span>
<span id="cb3-24"><a href="#cb3-24"></a>ds12 &lt;-<span class="st"> </span><span class="kw">rbind</span>(ds1, ds2)</span>
<span id="cb3-25"><a href="#cb3-25"></a></span>
<span id="cb3-26"><a href="#cb3-26"></a>ds3 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Response =</span> z3, <span class="dt">Predictor =</span> x1)</span>
<span id="cb3-27"><a href="#cb3-27"></a>ds4 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Response =</span> z4, <span class="dt">Predictor =</span> x2)</span>
<span id="cb3-28"><a href="#cb3-28"></a>ds34 &lt;-<span class="st"> </span><span class="kw">rbind</span>(ds3, ds4)</span>
<span id="cb3-29"><a href="#cb3-29"></a></span>
<span id="cb3-30"><a href="#cb3-30"></a>b12 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">ID =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>))</span>
<span id="cb3-31"><a href="#cb3-31"></a>spline.df2 &lt;-<span class="st"> </span><span class="kw">cbind</span>(b12, ds12)</span>
<span id="cb3-32"><a href="#cb3-32"></a>spline.df2 &lt;-<span class="st"> </span>spline.df2 <span class="op">%&gt;%</span></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(Predictor) <span class="op">%&gt;%</span></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">Stratum =</span> dplyr<span class="op">::</span><span class="kw">row_number</span>(),</span>
<span id="cb3-35"><a href="#cb3-35"></a>                <span class="dt">Cluster =</span> dplyr<span class="op">::</span><span class="kw">row_number</span>())</span>
<span id="cb3-36"><a href="#cb3-36"></a>spline.df2<span class="op">$</span>Stratum &lt;-<span class="st"> </span><span class="kw">cut</span>(spline.df2<span class="op">$</span>Stratum, <span class="dv">5</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</span>
<span id="cb3-37"><a href="#cb3-37"></a>spline.df2<span class="op">$</span>Cluster &lt;-<span class="st"> </span><span class="kw">cut</span>(spline.df2<span class="op">$</span>Cluster, <span class="dv">100</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">100</span>)</span>
<span id="cb3-38"><a href="#cb3-38"></a>spline.df2 &lt;-<span class="st"> </span>spline.df2 <span class="op">%&gt;%</span></span>
<span id="cb3-39"><a href="#cb3-39"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(ID) <span class="op">%&gt;%</span></span>
<span id="cb3-40"><a href="#cb3-40"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(ID, Response, Predictor, Cluster, Stratum)</span></code></pre></div>
</div>
<div id="todo-is-something-wrong-with-daic-calc" class="section level1">
<h1>TODO: Is something wrong with dAIC calc?</h1>
<p>TODO: Check on whether <code>survey::AIC()</code> is implemented correctly.</p>
<p>I am getting reasonably well-matched SHAPE of the AICs to the CV MSEs plotted, and I don’t know what the scale of the AICs “should” be…</p>
<p>BUT the <code>eff.p</code> and <code>deltabar</code> values returned by <code>AIC.svyglm()</code> seem ridiculously high. I would have expected <code>deltabar</code> around 1 when using SRS, but it was in the 10000s.</p>
<p>When I change the way I do <code>fpc</code>, or <code>weights</code>, or how I specify <code>ids</code>, it doesn’t matter.</p>
<p>But when I change the scale of the <code>Response</code> variable, that DOES matter. Is that how AIC is supposed to work? Don’t we want to be able to interpret <code>deltabar</code> as an average deff, regardless of the scale of y-variable?</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>modelsToFit &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Response~ns(Predictor, df=1)&quot;</span>, <span class="st">&quot;Response~ns(Predictor, df=2)&quot;</span>,</span>
<span id="cb4-2"><a href="#cb4-2"></a>                     <span class="st">&quot;Response~ns(Predictor, df=3)&quot;</span>, <span class="st">&quot;Response~ns(Predictor, df=4)&quot;</span>,</span>
<span id="cb4-3"><a href="#cb4-3"></a>                     <span class="st">&quot;Response~ns(Predictor, df=5)&quot;</span>, <span class="st">&quot;Response~ns(Predictor, df=6)&quot;</span>)</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a>n =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="kw">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb4-7"><a href="#cb4-7"></a>sim.srs &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">sample_n</span>(spline.df2, n)</span>
<span id="cb4-8"><a href="#cb4-8"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs, <span class="dt">fpc =</span> <span class="kw">rep</span>(n<span class="op">/</span><span class="dv">1000</span>, n))</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  105543.1 7863600.3  105543.1</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs, <span class="dt">fpc =</span> <span class="kw">rep</span>(<span class="dv">1000</span>, n))</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  105543.1 7863600.3  105543.1</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs, <span class="dt">weights =</span> <span class="kw">rep</span>(<span class="dv">1000</span><span class="op">/</span>n, n), <span class="dt">fpc =</span> <span class="kw">rep</span>(<span class="dv">1000</span>, n))</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  105543.1 7863600.3  105543.1</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="op">~</span><span class="dv">1</span>, <span class="dt">data =</span> sim.srs, <span class="dt">fpc =</span> <span class="kw">rep</span>(<span class="dv">1000</span>, n))</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  105543.1 7863600.3  105543.1</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="op">~</span><span class="dv">0</span>, <span class="dt">data =</span> sim.srs, <span class="dt">fpc =</span> <span class="kw">rep</span>(<span class="dv">1000</span>, n))</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  105543.1 7863600.3  105543.1</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="op">~</span><span class="dv">1</span>, <span class="dt">data =</span> sim.srs)</span></code></pre></div>
<pre><code>## Warning in svydesign.default(ids = ~1, data = sim.srs): No weights or
## probabilities supplied, assuming equal probability</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  117270.1 7887054.3  117270.1</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs, <span class="dt">weights =</span> <span class="kw">rep</span>(<span class="dv">1000</span><span class="op">/</span>n, n))</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  117270.1 7887054.3  117270.1</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># So rescaling the pop size doesn&#39;t matter EXCEPT through fpc, not through weights;</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="co"># and the way we specify `ids` doesn&#39;t matter.</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="co"># BUT the scale of the y-variable DOES matter:</span></span>
<span id="cb20-4"><a href="#cb20-4"></a></span>
<span id="cb20-5"><a href="#cb20-5"></a>sim.srs<span class="op">$</span>Response &lt;-<span class="st"> </span>sim.srs<span class="op">$</span>Response<span class="op">/</span><span class="dv">100</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs, <span class="dt">fpc =</span> <span class="kw">rep</span>(n<span class="op">/</span><span class="dv">1000</span>, n))</span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  10.55431 786.36003  10.55431</code></pre>
<p>Maybe it isn’t wrong. But if this <strong>is</strong> wrong, it might have to do with comparing what appears to be <code>svyglm()</code>’s equiv of <code>cov.scaled</code> with vanilla <code>summary(glm())</code>’s computed <code>cov.unscaled</code>, instead of comparing two <code>cov.scaled</code> to each other.</p>
<p>See <a href="https://rdrr.io/rforge/survey/src/R/survey.R">survey.R</a> and <a href="https://rdrr.io/rforge/survey/src/R/regtest.R">regTerm.R</a> for code.</p>
<p><code>AIC.svyglm</code> relies on <code>regTermTest</code> where the internal variable <code>misspec</code> becomes the returned variable <code>lambda</code> that <code>AIC.svyglm</code> uses to <code>deltabar</code>… And this <code>misspec</code> is <code>eigen(solve(V0)%*%V)$values</code> where <code>V0</code> is <code>svyglm$naive.cov</code> while <code>V</code> is <code>vcov(svyglm)</code>?</p>
<p><code>svyglm.survey.design()</code> returns an object with the element <code>naive.cov</code> which is <code>summary.glm()$cov.unscaled</code>. But it also returns its own element called <code>cov.unscaled</code> which is made by <code>svy.varcoef()</code> and <code>svyCprod()</code> but appears to be comparable to <code>cov.scaled</code> returned by <code>summary(glm())</code>.</p>
<p>And indeed if we fit a <code>svydesign</code> with no <code>fpc</code>, then <code>svyglm$naive.cov</code> is EXACTLY <code>glm$cov.unscaled</code>… while <code>svyglm$cov.unscaled</code> is CLOSE TO BUT NOT EXACTLY <code>glm$cov.scaled</code>. So (1) why are they close but NOT exact in 2nd case, for SRS design vs for iid glm? Shouldn’t we get the same thing in 2nd case too? And (2) why aren’t the names chosen to match up sensibly, so that cov.scaled and cov.unscaled mean the same thing for both svyglm and glm?</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>n =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="kw">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb22-3"><a href="#cb22-3"></a>sim.srs &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">sample_n</span>(spline.df2, n)</span>
<span id="cb22-4"><a href="#cb22-4"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs)</span></code></pre></div>
<pre><code>## Warning in svydesign.default(ids = 1:n, data = sim.srs): No weights or
## probabilities supplied, assuming equal probability</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des)<span class="op">$</span>naive.cov</span></code></pre></div>
<pre><code>##                       (Intercept) ns(Predictor, df = 1)
## (Intercept)            0.04192731           -0.07912324
## ns(Predictor, df = 1) -0.07912324            0.19608567</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des)<span class="op">$</span>cov.unscaled</span></code></pre></div>
<pre><code>##                       (Intercept) ns(Predictor, df = 1)
## (Intercept)              3233.622             -7688.415
## ns(Predictor, df = 1)   -7688.415             22994.994</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="kw">vcov</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##                       (Intercept) ns(Predictor, df = 1)
## (Intercept)              3233.622             -7688.415
## ns(Predictor, df = 1)   -7688.415             22994.994</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">summary</span>(<span class="kw">glm</span>(modelsToFit[<span class="dv">1</span>], <span class="dt">data =</span> sim.srs))<span class="op">$</span>cov.unscaled</span></code></pre></div>
<pre><code>##                       (Intercept) ns(Predictor, df = 1)
## (Intercept)            0.04192731           -0.07912324
## ns(Predictor, df = 1) -0.07912324            0.19608567</code></pre>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">summary</span>(<span class="kw">glm</span>(modelsToFit[<span class="dv">1</span>], <span class="dt">data =</span> sim.srs))<span class="op">$</span>cov.scaled</span></code></pre></div>
<pre><code>##                       (Intercept) ns(Predictor, df = 1)
## (Intercept)              3273.973             -6178.487
## ns(Predictor, df = 1)   -6178.487             15311.718</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="kw">vcov</span>(<span class="kw">glm</span>(modelsToFit[<span class="dv">1</span>], <span class="dt">data =</span> sim.srs))</span></code></pre></div>
<pre><code>##                       (Intercept) ns(Predictor, df = 1)
## (Intercept)              3273.973             -6178.487
## ns(Predictor, df = 1)   -6178.487             15311.718</code></pre>
<p>Which one is “correct” anyway?</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># This is the one we want indeed, NOT the glm$cov.unscaled or svyglm$naive.cov</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="kw">var</span>(sim.srs<span class="op">$</span>Response)<span class="op">/</span><span class="dv">100</span></span></code></pre></div>
<pre><code>## [1] 780.9079</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="kw">vcov</span>(<span class="kw">svymean</span>(<span class="op">~</span>Response, srs.des))</span></code></pre></div>
<pre><code>##          Response
## Response 780.9079</code></pre>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="kw">vcov</span>(<span class="kw">svyglm</span>(<span class="st">&quot;Response ~ 1&quot;</span>, srs.des))</span></code></pre></div>
<pre><code>##             (Intercept)
## (Intercept)    780.9079</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="kw">svyglm</span>(<span class="st">&quot;Response ~ 1&quot;</span>, srs.des)<span class="op">$</span>cov.unscaled</span></code></pre></div>
<pre><code>##             (Intercept)
## (Intercept)    780.9079</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">vcov</span>(<span class="kw">glm</span>(<span class="st">&quot;Response ~ 1&quot;</span>, <span class="dt">data =</span> sim.srs))</span></code></pre></div>
<pre><code>##             (Intercept)
## (Intercept)    780.9079</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="kw">summary</span>(<span class="kw">glm</span>(<span class="st">&quot;Response ~ 1&quot;</span>, <span class="dt">data =</span> sim.srs))<span class="op">$</span>cov.scaled</span></code></pre></div>
<pre><code>##             (Intercept)
## (Intercept)    780.9079</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="co"># This is NOT the one we want, not directly anyway</span></span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="kw">svyglm</span>(<span class="st">&quot;Response ~ 1&quot;</span>, srs.des)<span class="op">$</span>naive.cov</span></code></pre></div>
<pre><code>##             (Intercept)
## (Intercept)        0.01</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="kw">summary</span>(<span class="kw">glm</span>(<span class="st">&quot;Response ~ 1&quot;</span>, <span class="dt">data =</span> sim.srs))<span class="op">$</span>cov.unscaled</span></code></pre></div>
<pre><code>##             (Intercept)
## (Intercept)        0.01</code></pre>
<p>Final thing to check: We confirmed above that changing scale of Y for AIC.svyglm does change the AICs. What about for regular glm?</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>n =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="kw">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb52-3"><a href="#cb52-3"></a>sim.srs &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">sample_n</span>(spline.df2, n)</span>
<span id="cb52-4"><a href="#cb52-4"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs)</span></code></pre></div>
<pre><code>## Warning in svydesign.default(ids = 1:n, data = sim.srs): No weights or
## probabilities supplied, assuming equal probability</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  117270.1 7887054.3  117270.1</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="kw">AIC</span>(<span class="kw">glm</span>(modelsToFit[<span class="dv">1</span>], <span class="dt">data=</span>sim.srs))</span></code></pre></div>
<pre><code>## [1] 1414.325</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>sim.srs<span class="op">$</span>Response &lt;-<span class="st"> </span>sim.srs<span class="op">$</span>Response<span class="op">/</span><span class="dv">100</span></span>
<span id="cb58-2"><a href="#cb58-2"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs)</span></code></pre></div>
<pre><code>## Warning in svydesign.default(ids = 1:n, data = sim.srs): No weights or
## probabilities supplied, assuming equal probability</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a><span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des))</span></code></pre></div>
<pre><code>##     eff.p       AIC  deltabar 
##  11.72701 788.70543  11.72701</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a><span class="kw">AIC</span>(<span class="kw">glm</span>(modelsToFit[<span class="dv">1</span>], <span class="dt">data=</span>sim.srs))</span></code></pre></div>
<pre><code>## [1] 493.2911</code></pre>
<p>It DOES change the scale of AIC for regular glm too. WHY IS THAT? Doesn’t that screw up AIC comparisons, if scale of Y changes some things but not the <code>+2p</code> term? I guess we should ALSO check if changing the scale changes the raw differences…</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>n =<span class="st"> </span><span class="dv">100</span></span>
<span id="cb64-2"><a href="#cb64-2"></a><span class="kw">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb64-3"><a href="#cb64-3"></a>sim.srs &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">sample_n</span>(spline.df2, n)</span>
<span id="cb64-4"><a href="#cb64-4"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs)</span></code></pre></div>
<pre><code>## Warning in svydesign.default(ids = 1:n, data = sim.srs): No weights or
## probabilities supplied, assuming equal probability</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a><span class="op">-</span><span class="kw">diff</span>(<span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des), <span class="kw">svyglm</span>(modelsToFit[<span class="dv">2</span>], srs.des))[,<span class="st">&quot;AIC&quot;</span>])</span></code></pre></div>
<pre><code>## [1] 2161142</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a><span class="op">-</span><span class="kw">diff</span>(<span class="kw">AIC</span>(<span class="kw">glm</span>(modelsToFit[<span class="dv">1</span>], <span class="dt">data=</span>sim.srs), <span class="kw">glm</span>(modelsToFit[<span class="dv">2</span>], <span class="dt">data=</span>sim.srs))[,<span class="st">&quot;AIC&quot;</span>])</span></code></pre></div>
<pre><code>## [1] 32.71942</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a>sim.srs<span class="op">$</span>Response &lt;-<span class="st"> </span>sim.srs<span class="op">$</span>Response<span class="op">/</span><span class="dv">100</span></span>
<span id="cb70-2"><a href="#cb70-2"></a>srs.des &lt;-<span class="st"> </span><span class="kw">svydesign</span>(<span class="dt">ids =</span> <span class="dv">1</span><span class="op">:</span>n, <span class="dt">data =</span> sim.srs)</span></code></pre></div>
<pre><code>## Warning in svydesign.default(ids = 1:n, data = sim.srs): No weights or
## probabilities supplied, assuming equal probability</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a><span class="op">-</span><span class="kw">diff</span>(<span class="kw">AIC</span>(<span class="kw">svyglm</span>(modelsToFit[<span class="dv">1</span>], srs.des), <span class="kw">svyglm</span>(modelsToFit[<span class="dv">2</span>], srs.des))[,<span class="st">&quot;AIC&quot;</span>])</span></code></pre></div>
<pre><code>## [1] 216.1142</code></pre>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="op">-</span><span class="kw">diff</span>(<span class="kw">AIC</span>(<span class="kw">glm</span>(modelsToFit[<span class="dv">1</span>], <span class="dt">data=</span>sim.srs), <span class="kw">glm</span>(modelsToFit[<span class="dv">2</span>], <span class="dt">data=</span>sim.srs))[,<span class="st">&quot;AIC&quot;</span>])</span></code></pre></div>
<pre><code>## [1] 32.71942</code></pre>
<p>So rescaling Y by 1000 rescaled the differences by 1000 as well for svyglm. But it made no change at all in the diffs for glm. OK, so maybe this is all fine and working as it should…???</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
